name: CI

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  test:
    name: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25.6"
          check-latest: true
      - name: Run Go tests
        run: make test
      - name: Install Playwright
        run: go run github.com/playwright-community/playwright-go/cmd/playwright install --with-deps chromium
      - name: Run browser tests
        env:
          BROWSER_TEST_SKIP_PATTERNS: Pagination|Screenshot
        run: make test-browser

  deploy-preview:
    name: deploy-preview
    needs: test
    if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Install Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master
      - name: Deploy preview
        shell: bash
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN_STAGING }}
          FLY_ORG: commonink-staging
        run: |
          set -euo pipefail

          APP_ORG="${FLY_ORG}"
          BUCKET_NAME="commonink-staging-public"
          PR_NUMBER="${{ github.event.number }}"
          SLOT=$(( (PR_NUMBER - 1) % 3 + 1 ))
          APP_NAME="staging-${SLOT}-commonink"
          BASE_URL="https://${APP_NAME}.fly.dev"
          GOOGLE_REDIRECT_URL="${BASE_URL}/auth/google/callback"
          FLY_ARGS=(--org "${APP_ORG}")

          if [ -z "${FLY_API_TOKEN}" ]; then
            echo "Missing FLY_API_TOKEN_STAGING secret"
            exit 1
          fi

          if ! flyctl apps list --json "${FLY_ARGS[@]}" | jq -e --arg app "$APP_NAME" '.[] | select(.Name == $app)' > /dev/null; then
            echo "Preview app '${APP_NAME}' does not exist. Creating it."
            flyctl apps create "${APP_NAME}" "${FLY_ARGS[@]}" --yes
          fi

          if ! flyctl secrets list "${FLY_ARGS[@]}" --app "$APP_NAME" | grep -q "GOOGLE_CLIENT_ID"; then
            echo "Missing GOOGLE_CLIENT_ID secret in ${APP_NAME}."
            if [ -n "${APP_ORG}" ]; then
              echo "Run: flyctl secrets set --org ${APP_ORG} --app ${APP_NAME} GOOGLE_CLIENT_ID=... GOOGLE_CLIENT_SECRET=..."
            else
              echo "Run: flyctl secrets set --app ${APP_NAME} GOOGLE_CLIENT_ID=... GOOGLE_CLIENT_SECRET=..."
            fi
            exit 1
          fi

          flyctl secrets set \
            "BASE_URL=${BASE_URL}" \
            "GOOGLE_REDIRECT_URL=${GOOGLE_REDIRECT_URL}" \
            "BUCKET_NAME=${BUCKET_NAME}" \
            --app "${APP_NAME}" \
            "${FLY_ARGS[@]}"

          flyctl deploy \
            --remote-only \
            --config fly.staging.toml \
            --app "${APP_NAME}" \
            "${FLY_ARGS[@]}"
