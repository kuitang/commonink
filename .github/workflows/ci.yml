name: CI

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  test:
    name: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25.6"
          check-latest: true
      - name: Run Go tests
        run: make test
      - name: Install Playwright
        run: go run github.com/playwright-community/playwright-go/cmd/playwright install --with-deps chromium
      - name: Run browser tests
        run: make test-browser

  deploy-preview:
    name: deploy-preview
    needs: test
    if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Install Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master
      - name: Compute preview slot and app name
        id: app
        run: |
          PR_NUMBER="${{ github.event.number }}"
          SLOT=$(( (PR_NUMBER - 1) % 3 + 1 ))
          APP="staging-${SLOT}-commonink"
          APP="${APP:0:63}"
          APP="${APP%-}"
          BASE_URL="https://${APP}.fly.dev"
          GOOGLE_REDIRECT_URL="${BASE_URL}/auth/google/callback"
          echo "slot=$SLOT" >> "$GITHUB_OUTPUT"
          echo "name=$APP" >> "$GITHUB_OUTPUT"
          echo "base_url=$BASE_URL" >> "$GITHUB_OUTPUT"
          echo "google_redirect_url=$GOOGLE_REDIRECT_URL" >> "$GITHUB_OUTPUT"
      - name: Deploy preview
        shell: bash
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN_STAGING }}
        run: |
          APP_NAME="${{ steps.app.outputs.name }}"
          BUCKET_NAME="commonink-staging-public"
          BASE_URL="${{ steps.app.outputs.base_url }}"
          GOOGLE_REDIRECT_URL="${{ steps.app.outputs.google_redirect_url }}"

          if [ -z "${FLY_API_TOKEN}" ]; then
            echo "Missing FLY_API_TOKEN_STAGING secret"
            exit 1
          fi

          TMP_APPS_JSON="$(mktemp)"
          trap 'rm -f "$TMP_APPS_JSON"' EXIT

          if [ -n "${FLY_ORG:-}" ]; then
            if ! flyctl apps list --json --org "$FLY_ORG" > "$TMP_APPS_JSON" 2>/tmp/fly_org_err.txt; then
              if grep -q "Could not find organization" /tmp/fly_org_err.txt; then
              echo "FLY_ORG (${FLY_ORG}) not available for token. Falling back to token default org."
              unset FLY_ORG
            else
              echo "App lookup by org failed"
              cat /tmp/fly_org_err.txt
              exit 1
            fi
            fi
          fi

          if [ -z "${FLY_ORG:-}" ]; then
            if ! flyctl apps list --json > "$TMP_APPS_JSON" 2>/tmp/fly_org_err.txt; then
              echo "App lookup failed"
              cat /tmp/fly_org_err.txt
              exit 1
            fi
          fi

          if ! jq -e --arg app "$APP_NAME" '.[] | select(.Name == $app)' "$TMP_APPS_JSON" > /dev/null; then
            echo "Creating missing preview app: ${APP_NAME}"
            if [ -n "${FLY_ORG:-}" ]; then
              flyctl apps create "$APP_NAME" --org "$FLY_ORG" --yes
            else
              flyctl apps create "$APP_NAME" --yes
            fi
          else
            echo "Using existing preview app: ${APP_NAME}"
          fi

          if [ -z "${BUCKET_NAME}" ]; then
            echo "Missing BUCKET_NAME (hardcoded staging bucket name is required by config)"
            exit 1
          fi

          if ! flyctl secrets list --app "$APP_NAME" | grep -q "GOOGLE_CLIENT_ID"; then
            echo "Missing GOOGLE_CLIENT_ID secret in ${APP_NAME}. Set once with flyctl."
            exit 1
          fi

          flyctl secrets set \
            "BASE_URL=${BASE_URL}" \
            "GOOGLE_REDIRECT_URL=${GOOGLE_REDIRECT_URL}" \
            "BUCKET_NAME=${BUCKET_NAME}" \
            --app "${APP_NAME}"

          flyctl deploy \
            --remote-only \
            --config fly.staging.toml \
            --app "${APP_NAME}"
