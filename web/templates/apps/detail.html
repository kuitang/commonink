{{define "content"}}
<div class="flex-1 flex flex-col bg-gray-50 dark:bg-gray-900">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-6 flex-1 flex flex-col w-full">
        <div class="flex items-center gap-4 mb-6 flex-shrink-0">
            <a href="/notes" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </a>
            <div class="flex items-center gap-3 flex-1 min-w-0">
                <svg class="w-6 h-6 flex-shrink-0 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white truncate">{{.App.Name}}</h1>
                <span id="status-badge" class="flex-shrink-0 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{if eq .App.Status "running"}}bg-success-100 text-success-800 dark:bg-success-900 dark:text-success-200{{else if eq .App.Status "stopped"}}bg-error-100 text-error-800 dark:bg-error-900 dark:text-error-200{{else}}bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300{{end}}">{{.App.Status}}</span>
            </div>
            {{if .App.PublicURL}}<a href="{{.App.PublicURL}}" target="_blank" rel="noopener noreferrer" class="themed-btn-secondary px-3 py-1.5 text-sm inline-flex items-center gap-1">Open &#8599;</a>{{end}}
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 flex-1 min-h-0">
            <div class="themed-card p-4 lg:col-span-1 overflow-y-auto" style="max-height: 70vh;">
                <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Files</h3>
                <div id="file-list" class="space-y-1"><p class="text-xs text-gray-400">Loading...</p></div>
            </div>

            <div class="lg:col-span-3 flex flex-col gap-6 min-h-0">
                <div class="themed-card p-4 flex-1 flex flex-col min-h-0">
                    <div class="flex items-center justify-between mb-3">
                        <h3 id="editor-filename" class="text-sm font-semibold text-gray-700 dark:text-gray-300">Select a file</h3>
                    </div>
                    <textarea id="editor-content" readonly class="flex-1 w-full font-mono text-sm bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 border border-gray-200 dark:border-gray-700 rounded-input p-3 resize-none focus:outline-none" style="min-height: 200px;" placeholder="Select a file from the sidebar to view its contents."></textarea>
                </div>

                <div class="themed-card p-4">
                    <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Actions</h3>
                    <div class="flex gap-3 flex-wrap">
                        <button id="btn-start" onclick="doAction('start')" class="themed-btn-primary px-4 py-2 text-sm">Start</button>
                        <button id="btn-restart" onclick="doAction('restart')" class="themed-btn-secondary px-4 py-2 text-sm">Restart</button>
                        <button id="btn-stop" onclick="doAction('stop')" class="px-4 py-2 text-sm rounded-input border border-error-300 dark:border-error-700 text-error-700 dark:text-error-300 hover:bg-error-50 dark:hover:bg-error-900/50 transition-colors">Stop</button>
                    </div>
                    <div id="action-result" class="mt-3 hidden"><pre class="text-xs bg-gray-50 dark:bg-gray-900 p-2 rounded-input overflow-x-auto max-h-32 overflow-y-auto"></pre></div>
                </div>

                <div class="themed-card p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300">Logs</h3>
                        <div class="flex items-center gap-3">
                            <label class="flex items-center gap-1.5 text-xs text-gray-500 dark:text-gray-400 cursor-pointer">
                                <input type="checkbox" id="auto-refresh" class="rounded border-gray-300 dark:border-gray-600">
                                Auto-refresh
                            </label>
                            <button onclick="fetchLogs()" class="text-xs text-primary-600 dark:text-primary-400 hover:underline">Refresh</button>
                        </div>
                    </div>
                    <pre id="log-output" class="text-xs bg-gray-50 dark:bg-gray-900 p-3 rounded-input overflow-x-auto max-h-64 overflow-y-auto text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-700">Loading logs...</pre>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    var appName = {{.App.Name}};
    var autoRefreshInterval = null;

    function fetchFiles() {
        fetch('/api/apps/' + encodeURIComponent(appName) + '/files', {credentials: 'same-origin'})
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var list = document.getElementById('file-list');
                if (!data.files || data.files.length === 0) { list.innerHTML = '<p class="text-xs text-gray-400">No files found</p>'; return; }
                var html = '';
                data.files.forEach(function(f) {
                    if (f.kind === 'file') {
                        html += '<button data-path="' + f.path.replace(/"/g, '&quot;') + '" class="file-btn block w-full text-left px-2 py-1.5 text-xs rounded hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 truncate">' +
                            '<svg class="w-3.5 h-3.5 inline mr-1.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>' +
                            f.path + '</button>';
                    }
                });
                list.innerHTML = html || '<p class="text-xs text-gray-400">No files found</p>';
                list.querySelectorAll('.file-btn').forEach(function(btn) {
                    btn.addEventListener('click', function() { loadFile(this.getAttribute('data-path'), this); });
                });
            })
            .catch(function() { document.getElementById('file-list').innerHTML = '<p class="text-xs text-error-500">Failed to load files</p>'; });
    }

    function loadFile(path, btn) {
        document.getElementById('editor-filename').textContent = path;
        document.getElementById('editor-content').value = 'Loading...';
        document.querySelectorAll('.file-btn').forEach(function(b) { b.classList.remove('bg-primary-50', 'dark:bg-primary-900/30'); });
        if (btn) btn.classList.add('bg-primary-50', 'dark:bg-primary-900/30');
        fetch('/api/apps/' + encodeURIComponent(appName) + '/files/' + encodeURIComponent(path), {credentials: 'same-origin'})
            .then(function(r) { return r.json(); })
            .then(function(data) { document.getElementById('editor-content').value = data.content || ''; })
            .catch(function(e) { document.getElementById('editor-content').value = 'Error: ' + e.message; });
    }

    window.doAction = function(action) {
        var resultDiv = document.getElementById('action-result');
        var pre = resultDiv.querySelector('pre');
        resultDiv.classList.remove('hidden');
        pre.textContent = 'Running ' + action + '...';
        fetch('/api/apps/' + encodeURIComponent(appName) + '/' + action, {method: 'POST', credentials: 'same-origin'})
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var output = '';
                if (data.stdout) output += data.stdout;
                if (data.stderr) output += (output ? '\n' : '') + data.stderr;
                if (data.error) output = 'Error: ' + data.error;
                pre.textContent = output || action + ' completed';
                setTimeout(fetchLogs, 1000);
            })
            .catch(function(e) { pre.textContent = 'Error: ' + e.message; });
    };

    window.fetchLogs = function() {
        fetch('/api/apps/' + encodeURIComponent(appName) + '/logs?lines=100', {credentials: 'same-origin'})
            .then(function(r) { return r.json(); })
            .then(function(data) { var el = document.getElementById('log-output'); el.textContent = data.output || data.error || 'No logs available'; el.scrollTop = el.scrollHeight; })
            .catch(function(e) { document.getElementById('log-output').textContent = 'Error: ' + e.message; });
    };

    document.getElementById('auto-refresh').addEventListener('change', function() {
        if (this.checked) { fetchLogs(); autoRefreshInterval = setInterval(fetchLogs, 5000); }
        else { clearInterval(autoRefreshInterval); autoRefreshInterval = null; }
    });

    fetchFiles();
    fetchLogs();
})();
</script>
{{end}}
